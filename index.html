<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Fleur Diary ğŸŒ¸</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="theme-color" content="#ec4899" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Babelï¼ˆJSXå¤‰æ›ï¼‰ -->
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA manifestï¼ˆJSã§å‹•çš„ã«å·®ã—æ›¿ãˆï¼‰ -->
    <link id="app-manifest" rel="manifest" href="">
    <link id="apple-icon" rel="apple-touch-icon" href="">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <style>
      html,body,#root{height:100%;}
      /* èƒŒæ™¯ã‚¢ãƒ‹ãƒ¡ï¼ˆã‚„ã•ã—ã„ãƒ”ãƒ³ã‚¯ã®ã‚°ãƒ©ãƒ‡Ã—ãƒ‰ãƒƒãƒˆï¼‰ */
      @keyframes cuteGradient {0%{background-position:0 0}100%{background-position:400% 0}}
      .bg-kawaii{
        background:
          radial-gradient(rgba(236,72,153,.10) 1.2px, transparent 1.3px) 0 0/22px 22px,
          linear-gradient(120deg,#fff1f5,#ffe4e6,#ffe4f1,#fff1f5);
        background-size: 22px 22px, 400% 400%;
        animation: cuteGradient 18s ease infinite;
      }

      /* ãƒ¢ãƒã‚¤ãƒ«ã§ã‚‚ç¢ºå®Ÿã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã§ãã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ« */
      .modal-overlay{
        position:absolute; inset:0; background:rgba(0,0,0,.3); z-index:50;
        overflow-y:scroll; -webkit-overflow-scrolling:touch;
        height:100%;
      }
      .modal-box{
        width:94%; max-width:56rem; /* 3xl */
        background:#fff; border-radius:1rem; padding:1.25rem;
        margin:2rem auto; box-shadow:0 10px 25px rgba(0,0,0,.12);
        min-height:95vh;
      }
    </style>
  </head>
  <body class="bg-pink-50">
    <!-- èƒŒæ™¯ãƒ¬ã‚¤ãƒ¤ãƒ¼ -->
    <div id="bgDecor" class="fixed inset-0 -z-10 pointer-events-none bg-kawaii"></div>

    <div id="root"></div>

    <!-- Reactã‚¢ãƒ—ãƒªæœ¬ä½“ -->
    <script type="text/babel">
      const {useEffect,useMemo,useRef,useState} = React;

      /* ===== util ===== */
      const fmt=(d)=>new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const toISO=(d)=>fmt(d).toISOString().slice(0,10);
      const fromISO=(s)=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);};
      const todayISO=()=>toISO(new Date());
      const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
      const daysBetween=(aISO,bISO)=>Math.round((fmt(fromISO(bISO))-fmt(fromISO(aISO)))/86400000);
      const addDays=(iso,n)=>{const d=fromISO(iso);d.setDate(d.getDate()+n);return toISO(d);};
      const monthMatrix=(baseDate)=>{const first=new Date(baseDate.getFullYear(),baseDate.getMonth(),1);const start=new Date(first);start.setDate(start.getDate()-start.getDay());const weeks=[];for(let w=0;w<6;w++){const row=[];for(let d=0;d<7;d++){row.push(new Date(start));start.setDate(start.getDate()+1);}weeks.push(row);}return weeks;};
      const parseFlexDate=(s)=>{
        if(!s) return null;
        const t=s.trim().replace(/[.\s/]/g,'-').replace(/--+/g,'-');
        const m=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if(!m) return null;
        const y=+m[1], mo=+m[2], d=+m[3];
        if(mo<1||mo>12||d<1||d>31) return null;
        return toISO(new Date(y,mo-1,d));
      };

      /* ===== algo ===== */
      function calcCycleAvgWeighted(starts){
        if(!starts||starts.length<2) return 28;
        const diffs=[]; for(let i=1;i<starts.length;i++) diffs.push(daysBetween(starts[i-1],starts[i]));
        if(diffs.length===1) return clamp(Math.round(diffs[0]),20,45);
        if(diffs.length===2) return clamp(Math.round((diffs[0]+diffs[1])/2),20,45);
        const last3=diffs.slice(-3), w=[1,2,3];
        const num=last3.reduce((s,v,i)=>s+v*w[i],0), den=w.reduce((s,v)=>s+v,0);
        return clamp(Math.round(num/den),20,45);
      }
      function calcAvgBleedDays(periods){
        const spans=(periods||[]).filter(p=>p.start&&p.end).map(p=>daysBetween(p.start,p.end)+1).filter(d=>d>0&&d<14);
        if(!spans.length) return 5;
        return clamp(Math.round(spans.reduce((s,v)=>s+v,0)/spans.length),2,10);
      }

      /* === 3æ®µãƒãƒ³ãƒ‰ç”¨ === */
      function withAlpha(hex, a){
        const h=hex.replace("#",""); const n=parseInt(h,16);
        const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }
      function bandStyleFor(prof, iso){
        // å®Ÿç¸¾ï¼ˆé–‹å§‹ã€œçµ‚äº†ï¼é–‹å§‹ã®ã¿å½“æ—¥ï¼‰
        const actual = (prof.logs.periods||[]).some(pr=>{
          if(!pr.start) return false;
          if(pr.end)  return iso>=pr.start && iso<=pr.end;
          return iso===pr.start;
        });
        if(actual){ return { backgroundColor: withAlpha(prof.color, 0.55) }; }
        // äºˆæ¸¬ï¼ˆæœ€å¾Œã®é–‹å§‹ï¼‹å¹³å‡å‘¨æœŸã€œå¹³å‡å‡ºè¡€ï¼‰
        const starts=[...(prof.logs.periods||[])].map(x=>x.start).filter(Boolean).sort();
        if(starts.length){
          const cycle=calcCycleAvgWeighted(starts);
          const bleed=calcAvgBleedDays(prof.logs.periods);
          const lastStart=starts[starts.length-1];
          const nxStart=addDays(lastStart,cycle);
          const nxEnd=addDays(nxStart, bleed-1);
          if(iso>=nxStart && iso<=nxEnd){ return { backgroundColor: withAlpha(prof.color, 0.22) }; }
        }
        return {};
      }

      /* ===== data ===== */
      const DEFAULT_PROFILES = [
        { id:"p1", label:"Aã•ã‚“", color:"#f472b6", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p2", label:"Bã•ã‚“", color:"#fb7185", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p3", label:"Cã•ã‚“", color:"#f59e0b", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
      ];
      const FLAGS=["è…¹ç—›","é ­ç—›","ã ã‚‹ã•","ã‚¤ãƒ©ã‚¤ãƒ©","æ•æ„Ÿ","çœ ã„"];

      /* ===== icon helpersï¼ˆPNGâ†’PWAã‚¢ã‚¤ã‚³ãƒ³ï¼‰ ===== */
      async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
      function resizeDataURL(dataUrl, size){
        return new Promise((resolve)=>{
          const img=new Image(); img.onload=()=>{ 
            const s=Math.max(img.width,img.height);
            const c=document.createElement("canvas"); c.width=size; c.height=size;
            const ctx=c.getContext("2d");
            const off=document.createElement("canvas"); off.width=s; off.height=s;
            const o=off.getContext("2d"); o.clearRect(0,0,s,s);
            o.drawImage(img,(s-img.width)/2,(s-img.height)/2);
            ctx.imageSmoothingQuality="high";
            ctx.drawImage(off,0,0,size,size);
            resolve(c.toDataURL("image/png"));
          };
          img.src=dataUrl;
        });
      }
      async function setCustomIconsFromFile(file){
        const base = await fileToDataURL(file);
        const icon512 = await resizeDataURL(base,512);
        const icon192 = await resizeDataURL(base,192);
        const icon180 = await resizeDataURL(base,180);
        localStorage.setItem("period3_icon_512", icon512);
        localStorage.setItem("period3_icon_192", icon192);
        localStorage.setItem("period3_icon_180", icon180);
        applyManifestIcons(); 
      }
      function applyManifestIcons(){
        const i512 = localStorage.getItem("period3_icon_512");
        const i192 = localStorage.getItem("period3_icon_192");
        const i180 = localStorage.getItem("period3_icon_180");
        const v = String(Date.now());
        const manifestObj = {
          name: "Fleur Diary",
          short_name: "FleurDiary",
          start_url: ".",
          display: "standalone",
          background_color: "#fdf2f8",
          theme_color: "#ec4899",
          icons: [
            { src: i192 || i512 || "", sizes: "192x192", type: "image/png" },
            { src: i512 || i192 || "", sizes: "512x512", type: "image/png" }
          ]
        };
        const url = URL.createObjectURL(new Blob([JSON.stringify(manifestObj)],{type:"application/manifest+json"}));
        document.getElementById("app-manifest").setAttribute("href", url + "#v=" + v);
        if(i180) document.getElementById("apple-icon").setAttribute("href", i180 + "#v=" + v);
      }

      /* ===== Appï¼ˆæœ¬ä½“ï¼‰ ===== */
      function App(){
        const [profiles,setProfiles]=useState(DEFAULT_PROFILES);
        const [active,setActive]=useState(0);
        const [calBase,setCalBase]=useState(fmt(new Date()));
        const [showSettings,setShowSettings]=useState(false);
        const [showHistory,setShowHistory]=useState(false);
        const [bg,setBg]=useState(localStorage.getItem("fleur_bg")||"a");
        const lastNotifyKeyRef=useRef("");

        // å±¥æ­´ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ç”¨
        const [editRows,setEditRows]=useState([]);

        // èƒŒæ™¯é©ç”¨
        useEffect(()=>{
          const el=document.getElementById("bgDecor");
          el.className="fixed inset-0 -z-10 pointer-events-none bg-kawaii";
          localStorage.setItem("fleur_bg", bg);
        },[bg]);

        // load/save
        useEffect(()=>{
          const raw=localStorage.getItem("period3_profiles_v5");
          if(raw){ try{ const p=JSON.parse(raw); if(Array.isArray(p)&&p.length===3) setProfiles(p);}catch{} }
          lastNotifyKeyRef.current=localStorage.getItem("period3_last_notify_key")||"";
          applyManifestIcons();
        },[]);
        useEffect(()=>{ localStorage.setItem("period3_profiles_v5", JSON.stringify(profiles)); },[profiles]);

        // å±¥æ­´ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã„ãŸã‚‰ç·¨é›†ãƒãƒƒãƒ•ã‚¡ã‚’ä½œæˆ
        useEffect(()=>{
          if(!showHistory) return;
          const arr=[...(profiles[active].logs.periods||[])].sort((a,b)=>a.start.localeCompare(b.start));
          setEditRows(arr.map(pr=>({start:pr.start, end:pr.end||"", _origStart:pr.start, _origEnd:pr.end||""})));
        },[showHistory, active, profiles]);

        const p=profiles[active];
        const starts=useMemo(()=>[...p.logs.periods].map(x=>x.start).sort(),[p.logs.periods]);
        const cycleAvg=useMemo(()=>calcCycleAvgWeighted(starts),[starts]);
        const bleedAvg=useMemo(()=>calcAvgBleedDays(p.logs.periods),[p.logs.periods]);
        const lastStart=starts.length?starts[starts.length-1]:null;
        const nextStartPred= lastStart? addDays(lastStart,cycleAvg) : addDays(todayISO(),28);
        const daysLeft=daysBetween(todayISO(), nextStartPred);
        const currentOpen=p.logs.periods.find(pr=>pr.start && !pr.end);

        // å‰å›ï¼ˆçµ‚äº†ã‚ã‚Šã®æœ€æ–°ï¼‰
        const closed=[...(p.logs.periods||[])].filter(pr=>pr.start&&pr.end).sort((a,b)=>a.start.localeCompare(b.start));
        const prev=closed.length?closed[closed.length-1]:null;
        const prevSpanDays=prev?daysBetween(prev.start,prev.end)+1:null;

        // helpers
        const updateProfile=(i,fn)=>setProfiles(prev=>{const c=JSON.parse(JSON.stringify(prev)); fn(c[i]); return c;});
        const addPeriod=(i,startISO,endISO)=>{
          if(!startISO) return;
          const start=parseFlexDate(startISO)||startISO;
          const end=endISO? (parseFlexDate(endISO)||endISO) : null;
          if(end && start>end){ alert("çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã«ã—ã¦ãã ã•ã„"); return; }
          updateProfile(i,d=>{
            const exists=d.logs.periods.some(pr=>pr.start===start && (pr.end||"")===(end||""));
            if(!exists){ d.logs.periods=[...d.logs.periods,{start, end:end||null}].sort((a,b)=>a.start.localeCompare(b.start)); }
          });
        };
        const bulkAdd=(i,text)=>{
          const lines=(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
          let ok=0, ng=0;
          updateProfile(i,d=>{
            const arr=[...d.logs.periods];
            lines.forEach(l=>{
              const parts=l.split(/[\s,;\t]+/).filter(Boolean);
              const s=parseFlexDate(parts[0]); const e=parseFlexDate(parts[1]||"");
              if(!s){ ng++; return; }
              if(e && s>e){ ng++; return; }
              const dup=arr.some(pr=>pr.start===s && (pr.end||"")===(e||""));
              if(!dup){ arr.push({start:s, end:e||null}); ok++; }
            });
            arr.sort((a,b)=>a.start.localeCompare(b.start));
            d.logs.periods=arr;
          });
          return {ok, ng};
        };

        // actions
        const handleStart=()=>{ if(currentOpen) return; addPeriod(active, todayISO(), null); };
        const handleEnd=()=>{ if(!currentOpen) return; updateProfile(active,d=>{ d.logs.periods=d.logs.periods.map(pr=>pr.start===currentOpen.start?{...pr,end:todayISO()}:pr); }); };
        const setNotifyTime=(i,hh,mm)=>updateProfile(i,d=>{ d.notify.hh=hh; d.notify.mm=mm; });
        const setNotifyOn=(i,on)=>updateProfile(i,d=>{ d.notify.on=on; });
        const setLabel=(i,v)=>updateProfile(i,d=>{ d.label=v; });

        // day symptomsï¼ˆã‚·ãƒ³ãƒ—ãƒ«ç‰ˆï¼‰
        const day=todayISO();
        const daySym=p.logs.symptoms[day]||{flags:[],note:"",temp:""};
        const toggleFlag=(f)=>{const ex=daySym.flags.includes(f);const flags=ex?daySym.flags.filter(x=>x!==f):[...daySym.flags,f];updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,flags}}; });};
        const setNote=(v)=>updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,note:v}}; });
        const setTemp=(v)=>updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,temp:v}}; });

        const recent=[...p.logs.periods].sort((a,b)=>a.start.localeCompare(b.start)).slice(-6).reverse();

        // notificationsï¼ˆã‚¢ãƒ—ãƒªèµ·å‹•ä¸­ï¼‰
        useEffect(()=>{
          const id=setInterval(()=>{
            const now=new Date(); const key=`${toISO(new Date())}@${now.getHours()}:${now.getMinutes()}`;
            if(lastNotifyKeyRef.current===key) return;
            profiles.forEach(prof=>{
              if(!prof.notify?.on) return;
              if(prof.notify.hh===now.getHours() && prof.notify.mm===now.getMinutes()){
                const s=[...(prof.logs.periods||[])].map(x=>x.start).sort();
                const cyc=calcCycleAvgWeighted(s);
                const lastS=s.length?s[s.length-1]:null;
                const nextS= lastS? addDays(lastS,cyc) : addDays(todayISO(),28);
                const left=daysBetween(todayISO(), nextS);
                if(typeof Notification!=="undefined"){
                  const send=()=> new Notification(`${prof.label}: äºˆå®šæ—¥ã¾ã§ã‚ã¨${left}æ—¥`,{body:`æ¬¡å›äºˆæ¸¬: ${nextS}`});
                  if(Notification.permission==="granted") send();
                  else if(Notification.permission!=="denied"){ Notification.requestPermission().then(p=>{ if(p==="granted") send(); }); }
                }
              }
            });
            lastNotifyKeyRef.current=key;
            localStorage.setItem("period3_last_notify_key", key);
          },60000);
          return ()=>clearInterval(id);
        },[profiles]);

        // ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼é€±é…åˆ—
        const weeks=monthMatrix(calBase);

        /* ===== UI ===== */
        return (
          <div className="min-h-screen bg-pink-50 text-slate-900 p-4 font-sans">
            <div className="max-w-3xl mx-auto">
              <header className="mb-4 flex items-center justify-between pt-10">
                <div className="text-center w-full">
                  <h1 className="text-3xl font-extrabold text-pink-600">ğŸŒ¸ Fleur Diary</h1>
                  <p className="text-xs text-pink-400">3äººç®¡ç† / 3æ®µã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ / äºˆæ¸¬ / ä½“èª¿ / é€šçŸ¥ / PWA / å±¥æ­´ç·¨é›†ï¼ˆã‚¹ãƒãƒ›OKï¼‰</p>
                </div>
                <div className="absolute right-4 top-6 flex gap-2">
                  <button onClick={()=>setShowHistory(true)} title="éå»ã®è¨˜éŒ²ã‚’è¿½åŠ ãƒ»ç·¨é›†" className="rounded-full bg-white/70 hover:bg-white px-3 py-2 shadow border">ğŸ—“ï¸</button>
                  <button onClick={()=>setShowSettings(true)} title="è¨­å®š" className="rounded-full bg-white/70 hover:bg-white px-3 py-2 shadow border">âš™ï¸</button>
                </div>
              </header>

              {/* ãƒ—ãƒ­ãƒ•åˆ‡æ›¿ */}
              <div className="grid grid-cols-3 gap-2 mb-3">
                {profiles.map((prof,i)=>(
                  <button key={prof.id} onClick={()=>setActive(i)}
                    className={`rounded-full border px-3 py-2 shadow-md transition text-sm bg-white ${i===active?"ring-2 ring-pink-400":""}`}
                    style={{borderColor:prof.color,color:prof.color}}>
                    <div className="flex items-center justify-center gap-2">
                      <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                      <span className="font-semibold">{prof.label}</span>
                    </div>
                  </button>
                ))}
              </div>

              {/* æƒ…å ±ã‚«ãƒ¼ãƒ‰ */}
              <div className="grid md:grid-cols-3 gap-3 mb-4">
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">å¹³å‡å‘¨æœŸ: <span className="font-bold text-lg">{cycleAvg}æ—¥</span></div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">å¹³å‡å‡ºè¡€: <span className="font-bold text-lg">{bleedAvg}æ—¥</span></div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">{daysLeft>0?<span>äºˆå®šæ—¥ã¾ã§ã‚ã¨ <span className="font-extrabold text-xl text-pink-600">{daysLeft}</span> æ—¥</span>:<span className="font-bold text-pink-600">ä»Šæ—¥ãŒäºˆå®šæ—¥ï¼</span>}</div>
              </div>

              {/* å‰å›ã®ç”Ÿç† */}
              <section className="mb-4">
                <h2 className="text-lg font-bold text-pink-600 mb-2">å‰å›ã®ç”Ÿç†</h2>
                {prev ? (
                  <div className="rounded-2xl border bg-white p-3 shadow-sm">
                    <div><span className="font-semibold">{p.label}</span>ï¼š{prev.start} ã€œ {prev.end}ï¼ˆ<span className="font-semibold">{prevSpanDays}</span>æ—¥ï¼‰</div>
                  </div>
                ) : (
                  <div className="rounded-2xl border border-dashed bg-pink-50 p-4 text-center text-pink-400">ã¾ã ã€Œé–‹å§‹â†’çµ‚äº†ã€ã®è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>
                )}
              </section>

              {/* ãƒ¯ãƒ³ã‚¿ãƒƒãƒè¨˜éŒ² */}
              <div className="grid md:grid-cols-2 gap-3 mb-6">
                <button onClick={handleStart} disabled={!!currentOpen}
                  className={`w-full rounded-full p-4 text-lg font-semibold shadow-md transition ${currentOpen?"bg-pink-200 text-pink-800":"bg-pink-500 text-white"}`}>
                  {currentOpen ? "ğŸŒ¸ ç”Ÿç†ä¸­" : "ğŸŒ¸ ä»Šæ—¥ã‹ã‚‰é–‹å§‹"}
                </button>
                <button onClick={handleEnd} disabled={!currentOpen}
                  className={`w-full rounded-full p-4 text-lg font-semibold shadow-md transition ${!currentOpen?"bg-slate-200 text-slate-500":"bg-emerald-400 text-white"}`}>
                  âœ… ç”Ÿç†çµ‚äº†
                </button>
              </div>

              {/* ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ï¼ˆ3äººã‚’ä¸‰æ®µãƒãƒ³ãƒ‰ï¼‰ */}
              <section className="mb-6">
                <h2 className="text-lg font-bold text-pink-600 mb-2">ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼</h2>
                <div className="flex justify-between mb-2 items-center">
                  <button onClick={()=>setCalBase(new Date(calBase.getFullYear(), calBase.getMonth()-1, 1))} className="px-2 py-1 rounded-full bg-pink-200">â†</button>
                  <div className="font-semibold">{calBase.getFullYear()}å¹´ {calBase.getMonth()+1}æœˆ</div>
                  <button onClick={()=>setCalBase(new Date(calBase.getFullYear(), calBase.getMonth()+1, 1))} className="px-2 py-1 rounded-full bg-pink-200">â†’</button>
                </div>

                <table className="w-full border text-center text-sm overflow-hidden rounded-2xl">
                  <thead>
                    <tr className="bg-pink-100">
                      {["æ—¥","æœˆ","ç«","æ°´","æœ¨","é‡‘","åœŸ"].map(d=><th key={d} className="py-1">{d}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {monthMatrix(calBase).map((row,i)=>(
                      <tr key={i}>
                        {row.map(d=>{
                          const iso=toISO(d);
                          const inMonth=d.getMonth()===calBase.getMonth();
                          const aStyle=bandStyleFor(profiles[0], iso);
                          const bStyle=bandStyleFor(profiles[1], iso);
                          const cStyle=bandStyleFor(profiles[2], iso);
                          return (
                            <td key={iso} className={`border h-16 w-16 relative align-top ${inMonth?"bg-white":"bg-pink-50"}`}>
                              <div className="text-[10px] pr-1 pt-1 text-right opacity-70">{d.getDate()}</div>
                              <div className="absolute left-0 right-0 bottom-1 top-5 px-1">
                                <div className="grid grid-rows-3 gap-[2px] h-full">
                                  <div className="rounded-sm" style={aStyle} title={profiles[0].label}></div>
                                  <div className="rounded-sm" style={bStyle} title={profiles[1].label}></div>
                                  <div className="rounded-sm" style={cStyle} title={profiles[2].label}></div>
                                </div>
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="flex flex-wrap gap-3 items-center mt-2 text-xs">
                  {profiles.map(prof=>(
                    <div key={prof.id} className="flex items-center gap-1">
                      <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                      <span>{prof.label}</span>
                    </div>
                  ))}
                  <span className="ml-auto text-[11px] opacity-60">ä¸Šã‹ã‚‰ A / B / Cã€‚æ¿ƒè‰²=å®Ÿç¸¾ / è–„è‰²=äºˆæ¸¬</span>
                </div>
              </section>

              {/* ä»Šæ—¥ã®ä½“èª¿ */}
              <section className="mb-6">
                <h2 className="text-lg font-bold text-pink-600 mb-2">ä»Šæ—¥ã®ä½“èª¿ï¼ˆ{day}ï¼‰</h2>
                <div className="flex flex-wrap gap-2 mb-3">
                  {FLAGS.map(f=>(
                    <label key={f} className={`cursor-pointer rounded-full border px-3 py-1 text-sm shadow-sm ${daySym.flags.includes(f)?"bg-pink-400 text-white":"bg-white text-pink-500"}`}>
                      <input type="checkbox" className="hidden" checked={daySym.flags.includes(f)} onChange={()=>toggleFlag(f)} />
                      {f}
                    </label>
                  ))}
                </div>
                <div className="grid md:grid-cols-3 gap-3">
                  <input type="text" placeholder="ä½“æ¸© (ä¾‹: 36.7)" value={daySym.temp||""} onChange={(e)=>setTemp(e.target.value)} className="rounded-xl border px-3 py-2 shadow-sm" />
                  <input type="text" placeholder="ãƒ¡ãƒ¢" value={daySym.note||""} onChange={(e)=>setNote(e.target.value)} className="rounded-xl border px-3 py-2 shadow-sm md:col-span-2" />
                </div>
              </section>

              {/* æœ€è¿‘ã®è¨˜éŒ² */}
              <section className="mb-10">
                <h2 className="text-lg font-bold text-pink-600 mb-2">æœ€è¿‘ã®è¨˜éŒ²</h2>
                <div className="grid gap-2">
                  {recent.length===0 && <div className="rounded-2xl border border-dashed bg-pink-50 p-4 text-center text-pink-400">ã¾ã è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</div>}
                  {recent.map((pr,idx)=>(
                    <div key={idx} className="rounded-2xl border bg-white p-3 shadow-sm">
                      <div className="font-semibold">é–‹å§‹: {pr.start}</div>
                      <div>çµ‚äº†: {pr.end || "â€”"}</div>
                    </div>
                  ))}
                </div>
              </section>
            </div>

            {/* è¨­å®šãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆåå‰ & é€šçŸ¥ & èƒŒæ™¯ & ã‚¢ã‚¤ã‚³ãƒ³ & ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ï¼‰ */}
            {showSettings && (
              <div className="modal-overlay">
                <div className="modal-box max-w-md">
                  <h3 className="text-lg font-bold text-pink-600 mb-3">è¨­å®š</h3>

                  {/* åå‰ï¼†é€šçŸ¥ */}
                  <div className="grid gap-3 mb-4">
                    {profiles.map((prof,i)=>(
                      <div key={prof.id} className="rounded-xl border p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                          <input value={prof.label} onChange={(e)=>setLabel(i,e.target.value)}
                            className="flex-1 rounded-xl border px-3 py-2 shadow-sm" placeholder={`ãƒ¦ãƒ¼ã‚¶ãƒ¼${i+1}ã®åå‰`} />
                        </div>
                        <div className="flex items-center gap-2 text-sm">
                          <label className="flex items-center gap-2">
                            <input type="checkbox" checked={!!prof.notify?.on} onChange={(e)=>setNotifyOn(i,e.target.checked)} />
                            é€šçŸ¥ã‚’æœ‰åŠ¹ã«ã™ã‚‹
                          </label>
                          <input type="number" min="0" max="23" value={prof.notify.hh} onChange={(e)=>setNotifyTime(i,parseInt(e.target.value||0),prof.notify.mm)} className="w-14 rounded border px-2 py-1" /> :
                          <input type="number" min="0" max="59" value={prof.notify.mm} onChange={(e)=>setNotifyTime(i,prof.notify.hh,parseInt(e.target.value||0))} className="w-14 rounded border px-2 py-1" />
                          <span className="opacity-60">ï¼ˆäºˆå®šæ—¥ã¾ã§ã‚ã¨ä½•æ—¥ã‚’é€šçŸ¥ï¼‰</span>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«ï¼ˆç°¡æ˜“ï¼‰ */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-2">èƒŒæ™¯ã‚¹ã‚¿ã‚¤ãƒ«</div>
                    <div className="grid grid-cols-3 gap-2 text-sm">
                      <label className={`cursor-pointer rounded-xl border p-2 text-center ring-pink-200`}>
                        <input type="radio" name="bg" className="hidden" checked readOnly />
                        ãƒ”ãƒ³ã‚¯
                      </label>
                      <label className="cursor-not-allowed rounded-xl border p-2 text-center opacity-40">ï¼ˆä»–ã¯ä»Šã¯å›ºå®šï¼‰</label>
                      <label className="cursor-not-allowed rounded-xl border p-2 text-center opacity-40">â€”</label>
                    </div>
                  </div>

                  {/* PWAã‚¢ã‚¤ã‚³ãƒ³ */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-1">PWAã‚¢ã‚¤ã‚³ãƒ³ï¼ˆPNGï¼‰</div>
                    <input type="file" accept="image/*" onChange={async (e)=>{ const f=e.target.files?.[0]; if(f){ await setCustomIconsFromFile(f); alert("ã‚¢ã‚¤ã‚³ãƒ³ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨åæ˜ ã•ã‚Œã¾ã™ã€‚"); }}} />
                  </div>

                  {/* ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—/ã‚¤ãƒ³ãƒãƒ¼ãƒˆ */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-1">ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ— / ã‚¤ãƒ³ãƒãƒ¼ãƒˆ</div>
                    <div className="flex flex-wrap gap-2">
                      <button className="rounded-full bg-pink-500 text-white px-3 py-1 shadow" onClick={()=>exportJSON()}>JSONæ›¸ãå‡ºã—</button>
                      <button className="rounded-full bg-pink-500 text-white px-3 py-1 shadow" onClick={()=>exportCSV()}>CSVæ›¸ãå‡ºã—</button>
                      <label className="rounded-full bg-white px-3 py-1 shadow border cursor-pointer">
                        JSONèª­ã¿è¾¼ã¿
                        <input type="file" accept="application/json" className="hidden" onChange={importJSONFile}/>
                      </label>
                    </div>
                  </div>

                  <div className="flex gap-2 justify-end">
                    <button onClick={()=>setShowSettings(false)} className="rounded-full px-4 py-2 border">é–‰ã˜ã‚‹</button>
                    <button onClick={()=>setShowSettings(false)} className="rounded-full px-4 py-2 bg-pink-500 text-white shadow">ä¿å­˜</button>
                  </div>
                </div>
              </div>
            )}

            {/* éå»ã®è¨˜éŒ²ãƒ¢ãƒ¼ãƒ€ãƒ«ï¼ˆæ‰‹å‹•è¿½åŠ  / ã¾ã¨ã‚ç™»éŒ² / ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ«ï¼‰ */}
            {showHistory && (
              <div className="modal-overlay">
                <div className="modal-box">
                  <h3 className="text-lg font-bold text-pink-600 mb-3">éå»ã®ç”Ÿç†ï¼ˆ{profiles[active].label}ï¼‰</h3>

                  <div className="grid md:grid-cols-2 gap-6">
                    {/* æ‰‹å‹•è¿½åŠ  */}
                    <div>
                      <div className="font-semibold text-sm mb-2">1ä»¶ãšã¤è¿½åŠ </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                        <input id="hist-start" type="date" className="rounded-xl border px-3 py-2 shadow-sm" />
                        <span className="text-center text-sm">ã€œ</span>
                        <input id="hist-end" type="date" className="rounded-xl border px-3 py-2 shadow-sm" />
                      </div>
                      <div className="text-[11px] opacity-60 mt-1">â€» çµ‚äº†æ—¥ã¯ç©ºã§ã‚‚OKï¼ˆæœªçµ‚äº†ã¨ã—ã¦ç™»éŒ²ï¼‰</div>
                      <div className="mt-2 text-right">
                        <button className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                          onClick={()=>{
                            const s=document.getElementById("hist-start").value;
                            const e=document.getElementById("hist-end").value;
                            if(!s){ alert("é–‹å§‹æ—¥ã‚’å…¥ã‚Œã¦ã­"); return; }
                            addPeriod(active, s, e||null);
                            document.getElementById("hist-start").value="";
                            document.getElementById("hist-end").value="";
                            alert("è¿½åŠ ã—ã¾ã—ãŸï¼");
                          }}>è¿½åŠ ã™ã‚‹</button>
                      </div>

                      <hr className="my-4"/>

                      {/* ã¾ã¨ã‚ç™»éŒ² */}
                      <div className="mb-3">
                        <div className="font-semibold text-sm mb-2">ã¾ã¨ã‚ç™»éŒ²ï¼ˆã‚³ãƒ”ãƒšï¼‰</div>
                        <textarea id="hist-bulk" rows="6" className="w-full rounded-xl border px-3 py-2 shadow-sm" placeholder={`ä¾‹:
2024/05/01,2024/05/05
2024/03/29,2024/04/02
2024-02-26 2024-03-02`}></textarea>
                        <div className="text-[11px] opacity-60 mt-1">
                          1è¡Œ1ä»¶ã€<code>é–‹å§‹æ—¥,çµ‚äº†æ—¥</code>ï¼ˆã‚«ãƒ³ãƒ/ã‚¿ãƒ–/ã‚¹ãƒšãƒ¼ã‚¹OKï¼‰ï¼æ—¥ä»˜ã¯ <code>YYYY-MM-DD</code> / <code>YYYY/MM/DD</code> / <code>YYYY.MM.DD</code> ãªã©OK
                        </div>
                        <div className="mt-2 text-right">
                          <button className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                            onClick={()=>{
                              const txt=document.getElementById("hist-bulk").value;
                              const {ok,ng}=bulkAdd(active, txt);
                              alert(`ç™»éŒ²: ${ok}ä»¶ / ã‚¹ã‚­ãƒƒãƒ—: ${ng}ä»¶`);
                              document.getElementById("hist-bulk").value="";
                            }}>ã¾ã¨ã‚ã¦ç™»éŒ²</button>
                        </div>
                      </div>
                    </div>

                    {/* ç·¨é›†ãƒ†ãƒ¼ãƒ–ãƒ« */}
                    <div className="md:col-span-1">
                      <div className="font-semibold text-sm mb-2">æ—¢å­˜ã®è¨˜éŒ²ã‚’ç·¨é›† / å‰Šé™¤</div>
                      <div className="text-[11px] opacity-60 mb-2">æ—¥ä»˜ã‚’ç›´ã—ã¦ã€Œå¤‰æ›´ã‚’ä¿å­˜ã€ã€‚çµ‚äº†æ—¥ã‚’ç©ºæ¬„ã«ã™ã‚‹ã¨ã€Œæœªçµ‚äº†ã€æ‰±ã„ã«ã§ãã¾ã™ã€‚</div>
                      <div className="max-h-[60vh] overflow-y-auto border rounded-xl">
                        <table className="w-full text-sm">
                          <thead className="bg-pink-50 sticky top-0">
                            <tr>
                              <th className="p-2 text-left">é–‹å§‹</th>
                              <th className="p-2 text-left">çµ‚äº†</th>
                              <th className="p-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {editRows.length===0 && (
                              <tr><td className="p-3 text-slate-400" colSpan="3">è¨˜éŒ²ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>
                            )}
                            {editRows.map((row,idx)=>(
                              <tr key={row._origStart+"|"+row._origEnd} className="border-t">
                                <td className="p-2">
                                  <input type="date" value={row.start} onChange={(e)=>{
                                    const v=e.target.value; setEditRows(prev=>prev.map((r,i)=>i===idx?{...r,start:v}:r));
                                  }} className="rounded border px-2 py-1 w-full"/>
                                </td>
                                <td className="p-2">
                                  <div className="flex gap-2 items-center">
                                    <input type="date" value={row.end} onChange={(e)=>{
                                      const v=e.target.value; setEditRows(prev=>prev.map((r,i)=>i===idx?{...r,end:v}:r));
                                    }} className="rounded border px-2 py-1 w-full"/>
                                    <button title="æœªçµ‚äº†ã«ã™ã‚‹" className="text-xs px-2 py-1 border rounded" onClick={()=>{
                                      setEditRows(prev=>prev.map((r,i)=>i===idx?{...r,end:""}:r));
                                    }}>æœªçµ‚äº†</button>
                                  </div>
                                </td>
                                <td className="p-2 text-right">
                                  <button title="å‰Šé™¤" className="px-2 py-1 rounded bg-white border shadow-sm"
                                    onClick={()=>{
                                      if(!confirm("ã“ã®è¨˜éŒ²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
                                      setEditRows(prev=>prev.filter((_,i)=>i!==idx));
                                    }}>ğŸ—‘ï¸</button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="flex justify-end gap-2 mt-3">
                        <button className="rounded-full px-4 py-2 border" onClick={()=>setShowHistory(false)}>é–‰ã˜ã‚‹</button>
                        <button className="rounded-full px-4 py-2 bg-pink-500 text-white shadow"
                          onClick={()=>{
                            // æ¤œè¨¼
                            for(const r of editRows){
                              if(!r.start){ alert("é–‹å§‹æ—¥ã¯å¿…é ˆã§ã™"); return; }
                              if(r.end){
                                const s=parseFlexDate(r.start)||r.start, e=parseFlexDate(r.end)||r.end;
                                if(s>e){ alert(`çµ‚äº†æ—¥ã¯é–‹å§‹æ—¥ä»¥é™ã«ã—ã¦ãã ã•ã„\n(${r.start} â†’ ${r.end})`); return; }
                              }
                            }
                            // åæ˜ 
                            setProfiles(prev=>{
                              const c=JSON.parse(JSON.stringify(prev));
                              const arr=editRows.map(r=>({
                                start: parseFlexDate(r.start)||r.start,
                                end: r.end? (parseFlexDate(r.end)||r.end) : null
                              }));
                              arr.sort((a,b)=>a.start.localeCompare(b.start));
                              c[active].logs.periods=arr;
                              return c;
                            });
                            alert("å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼");
                          }}>å¤‰æ›´ã‚’ä¿å­˜</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            )}
          </div>
        );
      }

      /* export/import helpers */
      function download(filename,text){const blob=new Blob([text],{type:"text/plain;charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);}
      function exportJSON(){const raw=localStorage.getItem("period3_profiles_v5")||localStorage.getItem("period3_profiles_v4")||localStorage.getItem("period3_profiles_v3")||localStorage.getItem("period3_profiles_v2")||localStorage.getItem("period3_profiles_v1");const data=raw?JSON.parse(raw):null;const payload={version:"v0.11",exportedAt:new Date().toISOString(),profiles:data};download(`fleurdiary_backup_${toISO(new Date())}.json`,JSON.stringify(payload,null,2));}
      function exportCSV(){const raw=localStorage.getItem("period3_profiles_v5")||localStorage.getItem("period3_profiles_v4")||localStorage.getItem("period3_profiles_v3")||localStorage.getItem("period3_profiles_v2")||localStorage.getItem("period3_profiles_v1");const data=raw?JSON.parse(raw):[];const rows=[["user_id","name(label)","type","date","start","end","flags","temp","note"]];(data||[]).forEach(p=>{(p.logs.periods||[]).forEach(pr=>rows.push([p.id,p.label,"period","",pr.start||"",pr.end||"","","",""]));Object.entries(p.logs.symptoms||{}).forEach(([date,sym])=>rows.push([p.id,p.label,"symptom",date,"","",(sym.flags||[]).join("|"),sym.temp||"",String(sym.note||"").replace(/\n/g," ")]));});const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");download(`fleurdiary_export_${toISO(new Date())}.csv`,csv);}
      function importJSONFile(e){const file=e.target.files&&e.target.files[0];if(!file) return;const reader=new FileReader();reader.onload=()=>{try{const obj=JSON.parse(String(reader.result||"{}"));if(Array.isArray(obj))localStorage.setItem("period3_profiles_v5",JSON.stringify(obj));else if(obj&&Array.isArray(obj.profiles))localStorage.setItem("period3_profiles_v5",JSON.stringify(obj.profiles));else{alert("JSONã®å½¢å¼ãŒé•ã„ã¾ã™");return;}window.location.reload();}catch{alert("èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ");}};reader.readAsText(file);}

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>

    <!-- Service Workerï¼ˆã‚­ãƒ£ãƒƒã‚·ãƒ¥ç°¡æ˜“ï¼‰ -->
    <script>
      const swCode = `
        const CACHE_NAME="fleur-diary-cache-v1";
        const APP_SHELL=["/","/index.html"];
        self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(APP_SHELL)));self.skipWaiting();});
        self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE_NAME?caches.delete(k):Promise.resolve()))));self.clients.claim();});
        self.addEventListener("fetch",e=>{ if(e.request.method!=="GET")return; e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request).then(r=>{const copy=r.clone(); caches.open(CACHE_NAME).then(cx=>cx.put(e.request,copy)); return r;}).catch(()=>c)));});
      `;
      if ("serviceWorker" in navigator && (location.protocol === "https:" || location.hostname === "localhost")) {
        const swUrl = URL.createObjectURL(new Blob([swCode], {type:"text/javascript"}));
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    </script>
  </body>
</html>
