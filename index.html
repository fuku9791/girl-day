<!doctype html>
<html lang="ja">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Fleur Diary 🌸</title>
    <meta name="theme-color" content="#f9cfe3" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  </head>
  <body class="bg-pink-50 min-h-screen flex flex-col items-center font-sans">
    <div id="root" class="w-full max-w-3xl p-4"></div>

    <script type="text/babel">
      const { useState, useEffect } = React;

      const FleurDiary = () => {
        const [profiles, setProfiles] = useState([
          { label: "るか", color: "#f472b6", logs: { periods: [] } },
          { label: "なみ", color: "#fb7185", logs: { periods: [] } },
          { label: "みく", color: "#facc15", logs: { periods: [] } },
        ]);
        const [active, setActive] = useState(0);
        const [showHistory, setShowHistory] = useState(false);
        const [editRows, setEditRows] = useState([]);

        useEffect(() => {
          const saved = localStorage.getItem("fleur_v103");
          if (saved) setProfiles(JSON.parse(saved));
        }, []);

        useEffect(() => {
          localStorage.setItem("fleur_v103", JSON.stringify(profiles));
        }, [profiles]);

        const addPeriod = (idx, start, end) => {
          const newP = [...profiles];
          newP[idx].logs.periods.push({ start, end });
          setProfiles(newP);
        };

        const bulkAdd = (idx, text) => {
          const lines = text
            .split("\n")
            .map((l) => l.trim())
            .filter(Boolean);
          let ok = 0,
            ng = 0;
          const newP = [...profiles];
          for (let line of lines) {
            const m = line.match(
              /(\d{4}[-/.]\d{1,2}[-/.]\d{1,2})[\s,、\t]+(\d{4}[-/.]\d{1,2}[-/.]\d{1,2})?/
            );
            if (m) {
              newP[idx].logs.periods.push({
                start: m[1].replace(/[./]/g, "-"),
                end: m[2] ? m[2].replace(/[./]/g, "-") : null,
              });
              ok++;
            } else ng++;
          }
          setProfiles(newP);
          return { ok, ng };
        };

        const openHistory = () => {
          const list = profiles[active].logs.periods || [];
          const rows = list.map((r) => ({
            ...r,
            _origStart: r.start,
            _origEnd: r.end,
          }));
          setEditRows(rows);
          setShowHistory(true);
        };

        const parseFlexDate = (v) =>
          v ? v.replace(/[./]/g, "-").split("T")[0] : "";

        return (
          <div className="w-full">
            <h1 className="text-center text-2xl font-bold text-pink-600 mb-4 mt-4">
              🌸 Fleur Diary 🌸
            </h1>

            <div className="flex justify-center gap-2 mb-4">
              {profiles.map((p, i) => (
                <button
                  key={i}
                  className={`px-4 py-2 rounded-full font-semibold ${
                    active === i
                      ? "text-white"
                      : "text-gray-700 bg-white shadow"
                  }`}
                  style={{
                    backgroundColor:
                      active === i ? p.color : "rgba(255,255,255,0.8)",
                  }}
                  onClick={() => setActive(i)}
                >
                  {p.label}
                </button>
              ))}
            </div>

            <div className="bg-white rounded-2xl p-4 shadow-lg">
              <div className="text-sm text-gray-700 mb-2">
                📅 {profiles[active].label} の記録
              </div>
              <button
                onClick={openHistory}
                className="w-full bg-pink-500 text-white rounded-full py-2"
              >
                過去の記録を見る・編集する
              </button>
            </div>

            {/* 編集モーダル（スマホ完全対応版） */}
            {showHistory && (
              <div
                className="absolute inset-0 bg-black/30 z-50 overflow-y-scroll"
                style={{
                  WebkitOverflowScrolling: "touch",
                  height: "100%",
                }}
              >
                <div
                  className="mx-auto my-8 w-[94%] max-w-3xl rounded-2xl bg-white p-5 shadow-xl"
                  style={{
                    minHeight: "95vh",
                    maxHeight: "none",
                  }}
                >
                  <h3 className="text-lg font-bold text-pink-600 mb-3">
                    過去の生理（{profiles[active].label}）
                  </h3>

                  <div className="grid md:grid-cols-2 gap-6">
                    {/* 追加フォーム */}
                    <div>
                      <div className="font-semibold text-sm mb-2">
                        1件ずつ追加
                      </div>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                        <input
                          id="hist-start"
                          type="date"
                          className="rounded-xl border px-3 py-2 shadow-sm"
                        />
                        <span className="text-center text-sm">〜</span>
                        <input
                          id="hist-end"
                          type="date"
                          className="rounded-xl border px-3 py-2 shadow-sm"
                        />
                      </div>
                      <div className="text-[11px] opacity-60 mt-1">
                        ※ 終了日は空でもOK（未終了として登録）
                      </div>
                      <div className="mt-2 text-right">
                        <button
                          className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                          onClick={() => {
                            const s =
                              document.getElementById("hist-start").value;
                            const e =
                              document.getElementById("hist-end").value;
                            if (!s) {
                              alert("開始日を入れてね");
                              return;
                            }
                            addPeriod(active, s, e || null);
                            document.getElementById("hist-start").value = "";
                            document.getElementById("hist-end").value = "";
                            alert("追加しました！");
                          }}
                        >
                          追加する
                        </button>
                      </div>

                      <hr className="my-4" />

                      {/* まとめ登録 */}
                      <div className="mb-3">
                        <div className="font-semibold text-sm mb-2">
                          まとめ登録（コピペ）
                        </div>
                        <textarea
                          id="hist-bulk"
                          rows="6"
                          className="w-full rounded-xl border px-3 py-2 shadow-sm"
                          placeholder={`例:
2024/05/01,2024/05/05
2024/03/29,2024/04/02
2024-02-26 2024-03-02`}
                        ></textarea>
                        <div className="text-[11px] opacity-60 mt-1">
                          1行1件、開始日,終了日（カンマ/スペースOK）
                        </div>
                        <div className="mt-2 text-right">
                          <button
                            className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                            onClick={() => {
                              const txt =
                                document.getElementById("hist-bulk").value;
                              const { ok, ng } = bulkAdd(active, txt);
                              alert(`登録: ${ok}件 / スキップ: ${ng}件`);
                              document.getElementById("hist-bulk").value = "";
                            }}
                          >
                            まとめて登録
                          </button>
                        </div>
                      </div>
                    </div>

                    {/* 編集テーブル */}
                    <div className="md:col-span-1">
                      <div className="font-semibold text-sm mb-2">
                        既存の記録を編集 / 削除
                      </div>
                      <div className="text-[11px] opacity-60 mb-2">
                        日付を直して「変更を保存」。
                      </div>

                      <div className="max-h-[60vh] overflow-y-auto border rounded-xl">
                        <table className="w-full text-sm">
                          <thead className="bg-pink-50 sticky top-0">
                            <tr>
                              <th className="p-2 text-left">開始</th>
                              <th className="p-2 text-left">終了</th>
                              <th className="p-2"></th>
                            </tr>
                          </thead>
                          <tbody>
                            {editRows.length === 0 && (
                              <tr>
                                <td
                                  className="p-3 text-slate-400"
                                  colSpan="3"
                                >
                                  記録がありません
                                </td>
                              </tr>
                            )}
                            {editRows.map((row, idx) => (
                              <tr
                                key={row._origStart + "|" + row._origEnd}
                                className="border-t"
                              >
                                <td className="p-2">
                                  <input
                                    type="date"
                                    value={row.start}
                                    onChange={(e) => {
                                      const v = e.target.value;
                                      setEditRows((prev) =>
                                        prev.map((r, i) =>
                                          i === idx
                                            ? { ...r, start: v }
                                            : r
                                        )
                                      );
                                    }}
                                    className="rounded border px-2 py-1 w-full"
                                  />
                                </td>
                                <td className="p-2">
                                  <div className="flex gap-2 items-center">
                                    <input
                                      type="date"
                                      value={row.end}
                                      onChange={(e) => {
                                        const v = e.target.value;
                                        setEditRows((prev) =>
                                          prev.map((r, i) =>
                                            i === idx
                                              ? { ...r, end: v }
                                              : r
                                          )
                                        );
                                      }}
                                      className="rounded border px-2 py-1 w-full"
                                    />
                                    <button
                                      title="未終了にする"
                                      className="text-xs px-2 py-1 border rounded"
                                      onClick={() => {
                                        setEditRows((prev) =>
                                          prev.map((r, i) =>
                                            i === idx
                                              ? { ...r, end: "" }
                                              : r
                                          )
                                        );
                                      }}
                                    >
                                      未終了
                                    </button>
                                  </div>
                                </td>
                                <td className="p-2 text-right">
                                  <button
                                    title="削除"
                                    className="px-2 py-1 rounded bg-white border shadow-sm"
                                    onClick={() => {
                                      if (
                                        !confirm("この記録を削除しますか？")
                                      )
                                        return;
                                      setEditRows((prev) =>
                                        prev.filter((_, i) => i !== idx)
                                      );
                                    }}
                                  >
                                    🗑️
                                  </button>
                                </td>
                              </tr>
                            ))}
                          </tbody>
                        </table>
                      </div>

                      <div className="flex justify-end gap-2 mt-3">
                        <button
                          className="rounded-full px-4 py-2 border"
                          onClick={() => setShowHistory(false)}
                        >
                          閉じる
                        </button>
                        <button
                          className="rounded-full px-4 py-2 bg-pink-500 text-white shadow"
                          onClick={() => {
                            setProfiles((prev) => {
                              const c = JSON.parse(JSON.stringify(prev));
                              const arr = editRows.map((r) => ({
                                start:
                                  parseFlexDate(r.start) || r.start,
                                end: r.end
                                  ? parseFlexDate(r.end) || r.end
                                  : null,
                              }));
                              arr.sort((a, b) =>
                                a.start.localeCompare(b.start)
                              );
                              c[active].logs.periods = arr;
                              return c;
                            });
                            alert("変更を保存しました！");
                          }}
                        >
                          変更を保存
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      };

      ReactDOM.render(<FleurDiary />, document.getElementById("root"));
    </script>
  </body>
</html>
