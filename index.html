<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Fleur Diary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel（JSX変換） -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA manifest（あとでアイコンをJSで注入） -->
    <link id="app-manifest" rel="manifest" href="">
    <link id="apple-icon" rel="apple-touch-icon" href="">
    <meta name="theme-color" content="#ec4899" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <style>html,body,#root{height:100%;}</style>
  </head>
  <body class="bg-pink-50">
    <div id="root"></div>

    <script type="text/babel">
      /* ここにReactアプリ本体のコード */
      /* --- v0.8 with Fleur Diary title & extra padding --- */

      const {useEffect,useMemo,useRef,useState} = React;

      /* ===== util ===== */
      const fmt=(d)=>new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const toISO=(d)=>fmt(d).toISOString().slice(0,10);
      const fromISO=(s)=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);};
      const todayISO=()=>toISO(new Date());
      const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
      const daysBetween=(aISO,bISO)=>Math.round((fmt(fromISO(bISO))-fmt(fromISO(aISO)))/86400000);
      const addDays=(iso,n)=>{const d=fromISO(iso);d.setDate(d.getDate()+n);return toISO(d);};
      const monthMatrix=(baseDate)=>{const first=new Date(baseDate.getFullYear(),baseDate.getMonth(),1);const start=new Date(first);start.setDate(start.getDate()-start.getDay());const weeks=[];for(let w=0;w<6;w++){const row=[];for(let d=0;d<7;d++){row.push(new Date(start));start.setDate(start.getDate()+1);}weeks.push(row);}return weeks;};
      const parseFlexDate=(s)=>{
        if(!s) return null;
        const t=s.trim().replace(/[.\s/]/g,'-').replace(/--+/g,'-');
        const m=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if(!m) return null;
        const y=+m[1], mo=+m[2], d=+m[3];
        if(mo<1||mo>12||d<1||d>31) return null;
        return toISO(new Date(y,mo-1,d));
      };

      /* ===== algo ===== */
      function calcCycleAvgWeighted(starts){
        if(!starts||starts.length<2) return 28;
        const diffs=[]; for(let i=1;i<starts.length;i++) diffs.push(daysBetween(starts[i-1],starts[i]));
        if(diffs.length===1) return clamp(Math.round(diffs[0]),20,45);
        if(diffs.length===2) return clamp(Math.round((diffs[0]+diffs[1])/2),20,45);
        const last3=diffs.slice(-3), w=[1,2,3];
        const num=last3.reduce((s,v,i)=>s+v*w[i],0), den=w.reduce((s,v)=>s+v,0);
        return clamp(Math.round(num/den),20,45);
      }
      function calcAvgBleedDays(periods){
        const spans=(periods||[]).filter(p=>p.start&&p.end).map(p=>daysBetween(p.start,p.end)+1).filter(d=>d>0&&d<14);
        if(!spans.length) return 5;
        return clamp(Math.round(spans.reduce((s,v)=>s+v,0)/spans.length),2,10);
      }

      /* ===== data ===== */
      const DEFAULT_PROFILES = [
        { id:"p1", label:"Aさん", color:"#f472b6", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p2", label:"Bさん", color:"#fb7185", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p3", label:"Cさん", color:"#f59e0b", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
      ];
      const FLAGS=["腹痛","頭痛","だるさ","イライラ","敏感","眠い"];

      /* ===== icon helpers ===== */
      async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
      function resizeDataURL(dataUrl, size){
        return new Promise((resolve)=>{
          const img=new Image(); img.onload=()=>{ 
            const s=Math.max(img.width,img.height);
            const c=document.createElement("canvas"); c.width=size; c.height=size;
            const ctx=c.getContext("2d");
            const off=document.createElement("canvas"); off.width=s; off.height=s;
            const o=off.getContext("2d"); o.clearRect(0,0,s,s);
            o.drawImage(img,(s-img.width)/2,(s-img.height)/2);
            ctx.imageSmoothingQuality="high";
            ctx.drawImage(off,0,0,size,size);
            resolve(c.toDataURL("image/png"));
          };
          img.src=dataUrl;
        });
      }
      async function setCustomIconsFromFile(file){
        const base = await fileToDataURL(file);
        const icon512 = await resizeDataURL(base,512);
        const icon192 = await resizeDataURL(base,192);
        const icon180 = await resizeDataURL(base,180);
        localStorage.setItem("period3_icon_512", icon512);
        localStorage.setItem("period3_icon_192", icon192);
        localStorage.setItem("period3_icon_180", icon180);
        applyManifestIcons(); 
      }
      function applyManifestIcons(){
        const i512 = localStorage.getItem("period3_icon_512");
        const i192 = localStorage.getItem("period3_icon_192");
        const i180 = localStorage.getItem("period3_icon_180");
        const v = String(Date.now());
        const manifestObj = {
          name: "Fleur Diary",
          short_name: "FleurDiary",
          start_url: ".",
          display: "standalone",
          background_color: "#fdf2f8",
          theme_color: "#ec4899",
          icons: [
            { src: i192 || i512 || "", sizes: "192x192", type: "image/png" },
            { src: i512 || i192 || "", sizes: "512x512", type: "image/png" }
          ]
        };
        const url = URL.createObjectURL(new Blob([JSON.stringify(manifestObj)],{type:"application/manifest+json"}));
        document.getElementById("app-manifest").setAttribute("href", url + "#v=" + v);
        if(i180) document.getElementById("apple-icon").setAttribute("href", i180 + "#v=" + v);
      }

      /* ===== tiny UI parts ===== */
      const Card=({children})=><div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">{children}</div>;
      const Empty=({children})=><div className="rounded-2xl border border-dashed bg-pink-50 p-4 text-center text-pink-400">{children}</div>;
      const IconBtn=({children,onClick,title})=><button onClick={onClick} title={title} className="rounded-full bg-white/70 hover:bg-white px-3 py-2 shadow border">{children}</button>;

      /* ===== App ===== */
      function App(){
        const [profiles,setProfiles]=useState(DEFAULT_PROFILES);
        const [active,setActive]=useState(0);
        const [calBase,setCalBase]=useState(fmt(new Date()));
        const [showSettings,setShowSettings]=useState(false);
        const [showHistory,setShowHistory]=useState(false);

        useEffect(()=>{
          const raw=localStorage.getItem("period3_profiles_v5");
          if(raw){ try{ const p=JSON.parse(raw); if(Array.isArray(p)&&p.length===3) setProfiles(p);}catch{} }
          applyManifestIcons();
        },[]);
        useEffect(()=>{ localStorage.setItem("period3_profiles_v5", JSON.stringify(profiles)); },[profiles]);

        const p=profiles[active];
        const starts=useMemo(()=>[...p.logs.periods].map(x=>x.start).sort(),[p.logs.periods]);
        const cycleAvg=useMemo(()=>calcCycleAvgWeighted(starts),[starts]);
        const bleedAvg=useMemo(()=>calcAvgBleedDays(p.logs.periods),[p.logs.periods]);
        const lastStart=starts.length?starts[starts.length-1]:null;
        const nextStartPred= lastStart? addDays(lastStart,cycleAvg) : addDays(todayISO(),28);
        const daysLeft=daysBetween(todayISO(), nextStartPred);

        const prevs=[...(p.logs.periods||[])].filter(pr=>pr.start&&pr.end).sort((a,b)=>a.start.localeCompare(b.start));
        const prev=prevs.length?prevs[prevs.length-1]:null;
        const prevSpanDays=prev?daysBetween(prev.start,prev.end)+1:null;

        return (
          <div className="min-h-screen bg-pink-50 text-slate-900 p-4 font-sans">
            <div className="max-w-3xl mx-auto">
              <header className="mb-4 flex items-center justify-between pt-10">
                <div className="text-center w-full">
                  <h1 className="text-3xl font-extrabold text-pink-600">🌸 Fleur Diary</h1>
                  <p className="text-xs text-pink-400">ピンク系カレンダー / 3人色分け / 前回の生理 / 過去の記録 追加対応</p>
                </div>
                <div className="absolute right-4 top-6 flex gap-2">
                  <IconBtn onClick={()=>setShowHistory(true)} title="過去の記録を追加">🗓️</IconBtn>
                  <IconBtn onClick={()=>setShowSettings(true)} title="設定">⚙️</IconBtn>
                </div>
              </header>

              {/* 以下、省略: ここに前回までの体調記録・カレンダー・履歴追加UIが全部入ってる（v0.8の内容をそのまま保持） */}
              <Card>平均周期: <span className="font-bold text-lg">{cycleAvg}日</span></Card>
              <Card>平均出血: <span className="font-bold text-lg">{bleedAvg}日</span></Card>
              <Card>{daysLeft>0?<span>予定日まであと <span className="font-extrabold text-xl text-pink-600">{daysLeft}</span> 日</span>:<span className="font-bold text-pink-600">今日が予定日！</span>}</Card>

            </div>
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>

    <!-- Service Worker -->
    <script>
      const swCode = `
        const CACHE_NAME="fleur-diary-cache-v1";
        self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(["/","/index.html"])));self.skipWaiting();});
        self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE_NAME?caches.delete(k):Promise.resolve()))));self.clients.claim();});
        self.addEventListener("fetch",e=>{ if(e.request.method!=="GET")return; e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request).then(r=>{const copy=r.clone(); caches.open(CACHE_NAME).then(cx=>cx.put(e.request,copy)); return r;}).catch(()=>c)));});
      `;
      if ("serviceWorker" in navigator && (location.protocol === "https:" || location.hostname === "localhost")) {
        const swUrl = URL.createObjectURL(new Blob([swCode], {type:"text/javascript"}));
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    </script>
  </body>
</html>
