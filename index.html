<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>Fleur Diary</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React / ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
    <!-- Babel（JSX変換） -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- PWA manifest（あとでJSで注入） -->
    <link id="app-manifest" rel="manifest" href="">
    <link id="apple-icon" rel="apple-touch-icon" href="">
    <meta name="theme-color" content="#ec4899" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />

    <style>
      html,body,#root{height:100%;}

      /* ==== 背景A（ピンクドット＋グラデ） ==== */
      @keyframes cuteGradient {0%{background-position:0 0}100%{background-position:400% 0}}
      .bg-kawaii-a{
        background:
          radial-gradient(rgba(236,72,153,.12) 1.2px, transparent 1.3px) 0 0/22px 22px,
          linear-gradient(120deg,#fff1f5,#ffe4e6,#ffe4f1,#fff1f5);
        background-size: 22px 22px, 400% 400%;
        animation: cuteGradient 18s ease infinite;
      }

      /* ==== 背景B（うさぎ柄） ==== */
      .bg-kawaii-b{
        --tile: url("data:image/svg+xml;utf8,\
        <svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>\
          <rect width='100%' height='100%' fill='%23fff1f5'/>\
          <g transform='translate(8,10)'>\
            <rect x='0' y='0' width='36' height='24' rx='12' fill='white' stroke='%23ff77aa' stroke-width='2'/>\
            <circle cx='12' cy='12' r='2.5' fill='%2322253a'/>\
            <circle cx='24' cy='12' r='2.5' fill='%2322253a'/>\
            <circle cx='18' cy='15' r='2' fill='%2322253a'/>\
          </g>\
          <text x='46' y='18' font-size='16' font-family='Arial' fill='%23ff8fb7'>❤</text>\
        </svg>");
        background: var(--tile) 0 0/64px 64px, linear-gradient(180deg,#fff1f5,#ffe4e6);
      }

      /* ==== 背景C（ふわふわハート） ==== */
      @keyframes floatUp {
        0%{transform:translateY(20px);opacity:.0}
        15%{opacity:.18}
        100%{transform:translateY(-120vh);opacity:0}
      }
      .bg-kawaii-c{background:linear-gradient(180deg,#fff1f5,#ffe4e6);}
      .bg-kawaii-c .heart{
        position:absolute;bottom:-40px;opacity:.15;font-size:18px;
        animation:floatUp linear infinite;
      }
    </style>
  </head>
  <body class="bg-pink-50">
    <!-- 背景レイヤー -->
    <div id="bgDecor" class="fixed inset-0 -z-10 pointer-events-none"></div>

    <div id="root"></div>

    <!-- Reactアプリ本体 -->
    <script type="text/babel">
      const {useEffect,useMemo,useRef,useState} = React;

      /* ===== util ===== */
      const fmt=(d)=>new Date(d.getFullYear(),d.getMonth(),d.getDate());
      const toISO=(d)=>fmt(d).toISOString().slice(0,10);
      const fromISO=(s)=>{const [y,m,d]=s.split("-").map(Number);return new Date(y,m-1,d);};
      const todayISO=()=>toISO(new Date());
      const clamp=(v,lo,hi)=>Math.max(lo,Math.min(hi,v));
      const daysBetween=(aISO,bISO)=>Math.round((fmt(fromISO(bISO))-fmt(fromISO(aISO)))/86400000);
      const addDays=(iso,n)=>{const d=fromISO(iso);d.setDate(d.getDate()+n);return toISO(d);};
      const monthMatrix=(baseDate)=>{const first=new Date(baseDate.getFullYear(),baseDate.getMonth(),1);const start=new Date(first);start.setDate(start.getDate()-start.getDay());const weeks=[];for(let w=0;w<6;w++){const row=[];for(let d=0;d<7;d++){row.push(new Date(start));start.setDate(start.getDate()+1);}weeks.push(row);}return weeks;};
      const parseFlexDate=(s)=>{
        if(!s) return null;
        const t=s.trim().replace(/[.\s/]/g,'-').replace(/--+/g,'-');
        const m=t.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
        if(!m) return null;
        const y=+m[1], mo=+m[2], d=+m[3];
        if(mo<1||mo>12||d<1||d>31) return null;
        return toISO(new Date(y,mo-1,d));
      };

      /* ===== algo ===== */
      function calcCycleAvgWeighted(starts){
        if(!starts||starts.length<2) return 28;
        const diffs=[]; for(let i=1;i<starts.length;i++) diffs.push(daysBetween(starts[i-1],starts[i]));
        if(diffs.length===1) return clamp(Math.round(diffs[0]),20,45);
        if(diffs.length===2) return clamp(Math.round((diffs[0]+diffs[1])/2),20,45);
        const last3=diffs.slice(-3), w=[1,2,3];
        const num=last3.reduce((s,v,i)=>s+v*w[i],0), den=w.reduce((s,v)=>s+v,0);
        return clamp(Math.round(num/den),20,45);
      }
      function calcAvgBleedDays(periods){
        const spans=(periods||[]).filter(p=>p.start&&p.end).map(p=>daysBetween(p.start,p.end)+1).filter(d=>d>0&&d<14);
        if(!spans.length) return 5;
        return clamp(Math.round(spans.reduce((s,v)=>s+v,0)/spans.length),2,10);
      }

      /* === 3段バンド用（ここを “必ず” util群のあとに置く） === */
      function withAlpha(hex, a){
        const h=hex.replace("#",""); const n=parseInt(h,16);
        const r=(n>>16)&255, g=(n>>8)&255, b=n&255;
        return `rgba(${r}, ${g}, ${b}, ${a})`;
      }
      // プロフごとの、その日が「実績」or「予測」かを判定して色を返す
      function bandStyleFor(prof, iso){
        // 実績（開始〜終了、または開始して終了未入力の日）
        const actual = (prof.logs.periods||[]).some(pr=>{
          if(!pr.start) return false;
          if(pr.end)  return iso>=pr.start && iso<=pr.end;
          return iso===pr.start; // 開始だけの日はその日の実績扱い
        });
        if(actual){
          return { backgroundColor: withAlpha(prof.color, 0.55) };
        }
        // 予測（最後の開始日＋平均周期〜平均出血日数ぶん）
        const starts=[...(prof.logs.periods||[])].map(x=>x.start).filter(Boolean).sort();
        if(starts.length){
          const cycle=calcCycleAvgWeighted(starts);
          const bleed=calcAvgBleedDays(prof.logs.periods);
          const lastStart=starts[starts.length-1];
          const nxStart=addDays(lastStart,cycle);
          const nxEnd=addDays(nxStart, bleed-1);
          if(iso>=nxStart && iso<=nxEnd){
            return { backgroundColor: withAlpha(prof.color, 0.22) };
          }
        }
        return {}; // 何もなし
      }

      /* ===== data ===== */
      const DEFAULT_PROFILES = [
        { id:"p1", label:"Aさん", color:"#f472b6", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p2", label:"Bさん", color:"#fb7185", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
        { id:"p3", label:"Cさん", color:"#f59e0b", notify:{on:false,hh:8,mm:30}, logs:{periods:[],symptoms:{}} },
      ];
      const FLAGS=["腹痛","頭痛","だるさ","イライラ","敏感","眠い"];

      /* ===== icon helpers（PNG→PWAアイコン） ===== */
      async function fileToDataURL(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
      function resizeDataURL(dataUrl, size){
        return new Promise((resolve)=>{
          const img=new Image(); img.onload=()=>{ 
            const s=Math.max(img.width,img.height);
            const c=document.createElement("canvas"); c.width=size; c.height=size;
            const ctx=c.getContext("2d");
            const off=document.createElement("canvas"); off.width=s; off.height=s;
            const o=off.getContext("2d"); o.clearRect(0,0,s,s);
            o.drawImage(img,(s-img.width)/2,(s-img.height)/2);
            ctx.imageSmoothingQuality="high";
            ctx.drawImage(off,0,0,size,size);
            resolve(c.toDataURL("image/png"));
          };
          img.src=dataUrl;
        });
      }
      async function setCustomIconsFromFile(file){
        const base = await fileToDataURL(file);
        const icon512 = await resizeDataURL(base,512);
        const icon192 = await resizeDataURL(base,192);
        const icon180 = await resizeDataURL(base,180);
        localStorage.setItem("period3_icon_512", icon512);
        localStorage.setItem("period3_icon_192", icon192);
        localStorage.setItem("period3_icon_180", icon180);
        applyManifestIcons(); 
      }
      function applyManifestIcons(){
        const i512 = localStorage.getItem("period3_icon_512");
        const i192 = localStorage.getItem("period3_icon_192");
        const i180 = localStorage.getItem("period3_icon_180");
        const v = String(Date.now());
        const manifestObj = {
          name: "Fleur Diary",
          short_name: "FleurDiary",
          start_url: ".",
          display: "standalone",
          background_color: "#fdf2f8",
          theme_color: "#ec4899",
          icons: [
            { src: i192 || i512 || "", sizes: "192x192", type: "image/png" },
            { src: i512 || i192 || "", sizes: "512x512", type: "image/png" }
          ]
        };
        const url = URL.createObjectURL(new Blob([JSON.stringify(manifestObj)],{type:"application/manifest+json"}));
        document.getElementById("app-manifest").setAttribute("href", url + "#v=" + v);
        if(i180) document.getElementById("apple-icon").setAttribute("href", i180 + "#v=" + v);
      }

      /* ===== App（本体） ===== */
      function App(){
        const [profiles,setProfiles]=useState(DEFAULT_PROFILES);
        const [active,setActive]=useState(0);
        const [calBase,setCalBase]=useState(fmt(new Date()));
        const [showSettings,setShowSettings]=useState(false);
        const [showHistory,setShowHistory]=useState(false);
        const [bg,setBg]=useState(localStorage.getItem("fleur_bg")||"a");
        const lastNotifyKeyRef=useRef("");

        // 背景適用
        useEffect(()=>{
          const el=document.getElementById("bgDecor");
          if(bg==="a"){el.className="fixed inset-0 -z-10 pointer-events-none bg-kawaii-a";el.innerHTML="";}
          if(bg==="b"){el.className="fixed inset-0 -z-10 pointer-events-none bg-kawaii-b";el.innerHTML="";}
          if(bg==="c"){
            el.className="fixed inset-0 -z-10 pointer-events-none bg-kawaii-c";
            el.innerHTML=`
              <div class="heart" style="left:10%; animation-duration:16s;">❤</div>
              <div class="heart" style="left:30%; animation-duration:18s;">❤</div>
              <div class="heart" style="left:55%; animation-duration:20s;">❤</div>
              <div class="heart" style="left:75%; animation-duration:22s;">❤</div>
            `;
          }
          localStorage.setItem("fleur_bg", bg);
        },[bg]);

        // load/save
        useEffect(()=>{
          const raw=localStorage.getItem("period3_profiles_v5");
          if(raw){ try{ const p=JSON.parse(raw); if(Array.isArray(p)&&p.length===3) setProfiles(p);}catch{} }
          lastNotifyKeyRef.current=localStorage.getItem("period3_last_notify_key")||"";
          applyManifestIcons();
        },[]);
        useEffect(()=>{ localStorage.setItem("period3_profiles_v5", JSON.stringify(profiles)); },[profiles]);

        const p=profiles[active];
        const starts=useMemo(()=>[...p.logs.periods].map(x=>x.start).sort(),[p.logs.periods]);
        const cycleAvg=useMemo(()=>calcCycleAvgWeighted(starts),[starts]);
        const bleedAvg=useMemo(()=>calcAvgBleedDays(p.logs.periods),[p.logs.periods]);
        const lastStart=starts.length?starts[starts.length-1]:null;
        const nextStartPred= lastStart? addDays(lastStart,cycleAvg) : addDays(todayISO(),28);
        const daysLeft=daysBetween(todayISO(), nextStartPred);
        const currentOpen=p.logs.periods.find(pr=>pr.start && !pr.end);

        // 前回（終了ありの最新）
        const closed=[...(p.logs.periods||[])].filter(pr=>pr.start&&pr.end).sort((a,b)=>a.start.localeCompare(b.start));
        const prev=closed.length?closed[closed.length-1]:null;
        const prevSpanDays=prev?daysBetween(prev.start,prev.end)+1:null;

        // helpers
        const updateProfile=(i,fn)=>setProfiles(prev=>{const c=JSON.parse(JSON.stringify(prev)); fn(c[i]); return c;});
        const addPeriod=(i,startISO,endISO)=>{
          if(!startISO) return;
          const start=parseFlexDate(startISO)||startISO;
          const end=endISO? (parseFlexDate(endISO)||endISO) : null;
          if(end && start>end){ alert("終了日は開始日以降にしてください"); return; }
          updateProfile(i,d=>{
            const exists=d.logs.periods.some(pr=>pr.start===start && (pr.end||"")===(end||""));
            if(!exists){ d.logs.periods=[...d.logs.periods,{start, end:end||null}].sort((a,b)=>a.start.localeCompare(b.start)); }
          });
        };
        const bulkAdd=(i,text)=>{
          const lines=(text||"").split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
          let ok=0, ng=0;
          updateProfile(i,d=>{
            const arr=[...d.logs.periods];
            lines.forEach(l=>{
              const parts=l.split(/[\s,;\t]+/).filter(Boolean);
              const s=parseFlexDate(parts[0]); const e=parseFlexDate(parts[1]||"");
              if(!s){ ng++; return; }
              if(e && s>e){ ng++; return; }
              const dup=arr.some(pr=>pr.start===s && (pr.end||"")===(e||""));
              if(!dup){ arr.push({start:s, end:e||null}); ok++; }
            });
            arr.sort((a,b)=>a.start.localeCompare(b.start));
            d.logs.periods=arr;
          });
          return {ok, ng};
        };

        // actions
        const handleStart=()=>{ if(currentOpen) return; addPeriod(active, todayISO(), null); };
        const handleEnd=()=>{ if(!currentOpen) return; updateProfile(active,d=>{ d.logs.periods=d.logs.periods.map(pr=>pr.start===currentOpen.start?{...pr,end:todayISO()}:pr); }); };
        const setNotifyTime=(i,hh,mm)=>updateProfile(i,d=>{ d.notify.hh=hh; d.notify.mm=mm; });
        const setNotifyOn=(i,on)=>updateProfile(i,d=>{ d.notify.on=on; });
        const setLabel=(i,v)=>updateProfile(i,d=>{ d.label=v; });

        // day symptoms
        const day=todayISO();
        const daySym=p.logs.symptoms[day]||{flags:[],note:"",temp:""};
        const toggleFlag=(f)=>{const ex=daySym.flags.includes(f);const flags=ex?daySym.flags.filter(x=>x!==f):[...daySym.flags,f];updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,flags}}; });};
        const setNote=(v)=>updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,note:v}}; });
        const setTemp=(v)=>updateProfile(active,d=>{ d.logs.symptoms={...d.logs.symptoms,[day]:{...daySym,temp:v}}; });

        const recent=[...p.logs.periods].sort((a,b)=>a.start.localeCompare(b.start)).slice(-6).reverse();

        // notifications（アプリ起動中）
        useEffect(()=>{
          const id=setInterval(()=>{
            const now=new Date(); const key=`${toISO(new Date())}@${now.getHours()}:${now.getMinutes()}`;
            if(lastNotifyKeyRef.current===key) return;
            profiles.forEach(prof=>{
              if(!prof.notify?.on) return;
              if(prof.notify.hh===now.getHours() && prof.notify.mm===now.getMinutes()){
                const s=[...(prof.logs.periods||[])].map(x=>x.start).sort();
                const cyc=calcCycleAvgWeighted(s);
                const lastS=s.length?s[s.length-1]:null;
                const nextS= lastS? addDays(lastS,cyc) : addDays(todayISO(),28);
                const left=daysBetween(todayISO(), nextS);
                if(typeof Notification!=="undefined"){
                  const send=()=> new Notification(`${prof.label}: 予定日まであと${left}日`,{body:`次回予測: ${nextS}`});
                  if(Notification.permission==="granted") send();
                  else if(Notification.permission!=="denied"){ Notification.requestPermission().then(p=>{ if(p==="granted") send(); }); }
                }
              }
            });
            lastNotifyKeyRef.current=key;
            localStorage.setItem("period3_last_notify_key", key);
          },60000);
          return ()=>clearInterval(id);
        },[profiles]);

        // カレンダー週配列
        const weeks=monthMatrix(calBase);

        /* ===== UI ===== */
        return (
          <div className="min-h-screen bg-pink-50 text-slate-900 p-4 font-sans">
            <div className="max-w-3xl mx-auto">
              <header className="mb-4 flex items-center justify-between pt-10">
                <div className="text-center w-full">
                  <h1 className="text-3xl font-extrabold text-pink-600">🌸 Fleur Diary</h1>
                  <p className="text-xs text-pink-400">ピンク系カレンダー / 3人色分け / 3段バンド表示 / 過去登録 / 通知 / PWA</p>
                </div>
                <div className="absolute right-4 top-6 flex gap-2">
                  <button onClick={()=>setShowHistory(true)} title="過去の記録を追加" className="rounded-full bg-white/70 hover:bg-white px-3 py-2 shadow border">🗓️</button>
                  <button onClick={()=>setShowSettings(true)} title="設定" className="rounded-full bg-white/70 hover:bg-white px-3 py-2 shadow border">⚙️</button>
                </div>
              </header>

              {/* プロフ切替 */}
              <div className="grid grid-cols-3 gap-2 mb-3">
                {profiles.map((prof,i)=>(
                  <button key={prof.id} onClick={()=>setActive(i)}
                    className={`rounded-full border px-3 py-2 shadow-md transition text-sm bg-white ${i===active?"ring-2 ring-pink-400":""}`}
                    style={{borderColor:prof.color,color:prof.color}}>
                    <div className="flex items-center justify-center gap-2">
                      <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                      <span className="font-semibold">{prof.label}</span>
                    </div>
                  </button>
                ))}
              </div>

              {/* 情報カード */}
              <div className="grid md:grid-cols-3 gap-3 mb-4">
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">平均周期: <span className="font-bold text-lg">{cycleAvg}日</span></div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">平均出血: <span className="font-bold text-lg">{bleedAvg}日</span></div>
                <div className="rounded-2xl border bg-white p-4 shadow-sm text-center text-pink-600">{daysLeft>0?<span>予定日まであと <span className="font-extrabold text-xl text-pink-600">{daysLeft}</span> 日</span>:<span className="font-bold text-pink-600">今日が予定日！</span>}</div>
              </div>

              {/* 前回の生理 */}
              <section className="mb-4">
                <h2 className="text-lg font-bold text-pink-600 mb-2">前回の生理</h2>
                {prev ? (
                  <div className="rounded-2xl border bg-white p-3 shadow-sm">
                    <div><span className="font-semibold">{p.label}</span>：{prev.start} 〜 {prev.end}（<span className="font-semibold">{prevSpanDays}</span>日）</div>
                  </div>
                ) : (
                  <div className="rounded-2xl border border-dashed bg-pink-50 p-4 text-center text-pink-400">まだ「開始→終了」の記録がありません</div>
                )}
              </section>

              {/* ワンタッチ記録 */}
              <div className="grid md:grid-cols-2 gap-3 mb-6">
                <button onClick={handleStart} disabled={!!currentOpen}
                  className={`w-full rounded-full p-4 text-lg font-semibold shadow-md transition ${currentOpen?"bg-pink-200 text-pink-800":"bg-pink-500 text-white"}`}>
                  {currentOpen ? "🌸 生理中" : "🌸 今日から開始"}
                </button>
                <button onClick={handleEnd} disabled={!currentOpen}
                  className={`w-full rounded-full p-4 text-lg font-semibold shadow-md transition ${!currentOpen?"bg-slate-200 text-slate-500":"bg-emerald-400 text-white"}`}>
                  ✅ 生理終了
                </button>
              </div>

              {/* カレンダー（3段バンド表示） */}
              <section className="mb-6">
                <h2 className="text-lg font-bold text-pink-600 mb-2">カレンダー</h2>
                <div className="flex justify-between mb-2 items-center">
                  <button onClick={()=>setCalBase(new Date(calBase.getFullYear(), calBase.getMonth()-1, 1))} className="px-2 py-1 rounded-full bg-pink-200">←</button>
                  <div className="font-semibold">{calBase.getFullYear()}年 {calBase.getMonth()+1}月</div>
                  <button onClick={()=>setCalBase(new Date(calBase.getFullYear(), calBase.getMonth()+1, 1))} className="px-2 py-1 rounded-full bg-pink-200">→</button>
                </div>

                <table className="w-full border text-center text-sm overflow-hidden rounded-2xl">
                  <thead>
                    <tr className="bg-pink-100">
                      {["日","月","火","水","木","金","土"].map(d=><th key={d} className="py-1">{d}</th>)}
                    </tr>
                  </thead>
                  <tbody>
                    {weeks.map((row,i)=>(
                      <tr key={i}>
                        {row.map(d=>{
                          const iso=toISO(d);
                          const inMonth=d.getMonth()===calBase.getMonth();
                          const aStyle=bandStyleFor(profiles[0], iso);
                          const bStyle=bandStyleFor(profiles[1], iso);
                          const cStyle=bandStyleFor(profiles[2], iso);
                          return (
                            <td key={iso} className={`border h-16 w-16 relative align-top ${inMonth?"bg-white":"bg-pink-50"}`}>
                              <div className="text-[10px] pr-1 pt-1 text-right opacity-70">{d.getDate()}</div>
                              <div className="absolute left-0 right-0 bottom-1 top-5 px-1">
                                <div className="grid grid-rows-3 gap-[2px] h-full">
                                  <div className="rounded-sm" style={aStyle} title={profiles[0].label}></div>
                                  <div className="rounded-sm" style={bStyle} title={profiles[1].label}></div>
                                  <div className="rounded-sm" style={cStyle} title={profiles[2].label}></div>
                                </div>
                              </div>
                            </td>
                          );
                        })}
                      </tr>
                    ))}
                  </tbody>
                </table>
                <div className="flex flex-wrap gap-3 items-center mt-2 text-xs">
                  {profiles.map(prof=>(
                    <div key={prof.id} className="flex items-center gap-1">
                      <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                      <span>{prof.label}</span>
                    </div>
                  ))}
                  <span className="ml-auto text-[11px] opacity-60">上から A / B / C。濃色=実績 / 薄色=予測</span>
                </div>
              </section>

              {/* 今日の体調 */}
              <section className="mb-6">
                <h2 className="text-lg font-bold text-pink-600 mb-2">今日の体調（{day}）</h2>
                <div className="flex flex-wrap gap-2 mb-3">
                  {FLAGS.map(f=>(
                    <label key={f} className={`cursor-pointer rounded-full border px-3 py-1 text-sm shadow-sm ${daySym.flags.includes(f)?"bg-pink-400 text-white":"bg-white text-pink-500"}`}>
                      <input type="checkbox" className="hidden" checked={daySym.flags.includes(f)} onChange={()=>toggleFlag(f)} />
                      {f}
                    </label>
                  ))}
                </div>
                <div className="grid md:grid-cols-3 gap-3">
                  <input type="text" placeholder="体温 (例: 36.7)" value={daySym.temp||""} onChange={(e)=>setTemp(e.target.value)} className="rounded-xl border px-3 py-2 shadow-sm" />
                  <input type="text" placeholder="メモ" value={daySym.note||""} onChange={(e)=>setNote(e.target.value)} className="rounded-xl border px-3 py-2 shadow-sm md:col-span-2" />
                </div>
              </section>

              {/* 最近の記録 */}
              <section className="mb-10">
                <h2 className="text-lg font-bold text-pink-600 mb-2">最近の記録</h2>
                <div className="grid gap-2">
                  {recent.length===0 && <div className="rounded-2xl border border-dashed bg-pink-50 p-4 text-center text-pink-400">まだ記録がありません</div>}
                  {recent.map((pr,idx)=>(
                    <div key={idx} className="rounded-2xl border bg-white p-3 shadow-sm">
                      <div className="font-semibold">開始: {pr.start}</div>
                      <div>終了: {pr.end || "—"}</div>
                    </div>
                  ))}
                </div>
              </section>
            </div>

            {/* 設定モーダル（名前 & 通知 & 背景 & アイコン & バックアップ） */}
            {showSettings && (
              <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50">
                <div className="w-full max-w-md rounded-2xl bg-white p-5 shadow-xl">
                  <h3 className="text-lg font-bold text-pink-600 mb-3">設定</h3>

                  {/* 名前＆通知 */}
                  <div className="grid gap-3 mb-4">
                    {profiles.map((prof,i)=>(
                      <div key={prof.id} className="rounded-xl border p-3">
                        <div className="flex items-center gap-2 mb-2">
                          <span className="inline-block w-3 h-3 rounded" style={{backgroundColor:prof.color}}></span>
                          <input value={prof.label} onChange={(e)=>setLabel(i,e.target.value)}
                            className="flex-1 rounded-xl border px-3 py-2 shadow-sm" placeholder={`ユーザー${i+1}の名前`} />
                        </div>
                        <div className="flex items-center gap-2 text-sm">
                          <label className="flex items-center gap-2">
                            <input type="checkbox" checked={!!prof.notify?.on} onChange={(e)=>setNotifyOn(i,e.target.checked)} />
                            通知を有効にする
                          </label>
                          <input type="number" min="0" max="23" value={prof.notify.hh} onChange={(e)=>setNotifyTime(i,parseInt(e.target.value||0),prof.notify.mm)} className="w-14 rounded border px-2 py-1" /> :
                          <input type="number" min="0" max="59" value={prof.notify.mm} onChange={(e)=>setNotifyTime(i,prof.notify.hh,parseInt(e.target.value||0))} className="w-14 rounded border px-2 py-1" />
                          <span className="opacity-60">（予定日まであと何日を通知）</span>
                        </div>
                      </div>
                    ))}
                  </div>

                  {/* 背景スタイル */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-2">背景スタイル</div>
                    <div className="grid grid-cols-3 gap-2 text-sm">
                      <label className={`cursor-pointer rounded-xl border p-2 text-center ${bg==="a"?"ring-2 ring-pink-400":""}`}>
                        <input type="radio" name="bg" className="hidden" checked={bg==="a"} onChange={()=>setBg("a")} />
                        ドット
                      </label>
                      <label className={`cursor-pointer rounded-xl border p-2 text-center ${bg==="b"?"ring-2 ring-pink-400":""}`}>
                        <input type="radio" name="bg" className="hidden" checked={bg==="b"} onChange={()=>setBg("b")} />
                        うさぎ
                      </label>
                      <label className={`cursor-pointer rounded-xl border p-2 text-center ${bg==="c"?"ring-2 ring-pink-400":""}`}>
                        <input type="radio" name="bg" className="hidden" checked={bg==="c"} onChange={()=>setBg("c")} />
                        ハート
                      </label>
                    </div>
                  </div>

                  {/* PWAアイコン */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-1">PWAアイコン（PNG）</div>
                    <input type="file" accept="image/*" onChange={async (e)=>{ const f=e.target.files?.[0]; if(f){ await setCustomIconsFromFile(f); alert("アイコンを適用しました。ホーム画面に追加すると反映されます。"); }}} />
                  </div>

                  {/* バックアップ/インポート */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-1">バックアップ / インポート</div>
                    <div className="flex flex-wrap gap-2">
                      <button className="rounded-full bg-pink-500 text-white px-3 py-1 shadow" onClick={()=>exportJSON()}>JSON書き出し</button>
                      <button className="rounded-full bg-pink-500 text-white px-3 py-1 shadow" onClick={()=>exportCSV()}>CSV書き出し</button>
                      <label className="rounded-full bg-white px-3 py-1 shadow border cursor-pointer">
                        JSON読み込み
                        <input type="file" accept="application/json" className="hidden" onChange={importJSONFile}/>
                      </label>
                    </div>
                  </div>

                  <div className="flex gap-2 justify-end">
                    <button onClick={()=>setShowSettings(false)} className="rounded-full px-4 py-2 border">閉じる</button>
                    <button onClick={()=>setShowSettings(false)} className="rounded-full px-4 py-2 bg-pink-500 text-white shadow">保存</button>
                  </div>
                </div>
              </div>
            )}

            {/* 過去の記録モーダル（手動追加 / まとめ登録） */}
            {showHistory && (
              <div className="fixed inset-0 bg-black/30 flex items-center justify-center p-4 z-50">
                <div className="w-full max-w-lg rounded-2xl bg-white p-5 shadow-xl">
                  <h3 className="text-lg font-bold text-pink-600 mb-3">過去の生理を追加（{profiles[active].label}）</h3>

                  {/* 手動追加 */}
                  <div className="mb-4">
                    <div className="font-semibold text-sm mb-2">1件ずつ追加</div>
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-2 items-center">
                      <input id="hist-start" type="date" className="rounded-xl border px-3 py-2 shadow-sm" />
                      <span className="text-center text-sm">〜</span>
                      <input id="hist-end" type="date" className="rounded-xl border px-3 py-2 shadow-sm" />
                    </div>
                    <div className="text-[11px] opacity-60 mt-1">※ 終了日は空でもOK（未終了として登録）</div>
                    <div className="mt-2 text-right">
                      <button className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                        onClick={()=>{
                          const s=document.getElementById("hist-start").value;
                          const e=document.getElementById("hist-end").value;
                          if(!s){ alert("開始日を入れてね"); return; }
                          addPeriod(active, s, e||null);
                          document.getElementById("hist-start").value="";
                          document.getElementById("hist-end").value="";
                          alert("追加しました！");
                        }}>追加する</button>
                    </div>
                  </div>

                  <hr className="my-4"/>

                  {/* まとめ登録 */}
                  <div className="mb-3">
                    <div className="font-semibold text-sm mb-2">まとめ登録（コピペ）</div>
                    <textarea id="hist-bulk" rows="6" className="w-full rounded-xl border px-3 py-2 shadow-sm" placeholder={`例:
2024/05/01,2024/05/05
2024/03/29,2024/04/02
2024-02-26 2024-03-02`}></textarea>
                    <div className="text-[11px] opacity-60 mt-1">
                      1行1件、<code>開始日,終了日</code>（区切りはカンマ/タブ/スペースOK）／日付は <code>YYYY-MM-DD</code> / <code>YYYY/MM/DD</code> / <code>YYYY.MM.DD</code> などOK
                    </div>
                    <div className="mt-2 text-right">
                      <button className="rounded-full bg-pink-500 text-white px-4 py-2 shadow"
                        onClick={()=>{
                          const txt=document.getElementById("hist-bulk").value;
                          const {ok,ng}=bulkAdd(active, txt);
                          alert(`登録: ${ok}件 / スキップ: ${ng}件`);
                          document.getElementById("hist-bulk").value="";
                        }}>まとめて登録</button>
                    </div>
                  </div>

                  <div className="flex gap-2 justify-end mt-2">
                    <button onClick={()=>setShowHistory(false)} className="rounded-full px-4 py-2 border">閉じる</button>
                  </div>
                </div>
              </div>
            )}
          </div>
        );
      }

      /* export/import helpers */
      function download(filename,text){const blob=new Blob([text],{type:"text/plain;charset=utf-8"});const url=URL.createObjectURL(blob);const a=document.createElement("a");a.href=url;a.download=filename;a.click();URL.revokeObjectURL(url);}
      function exportJSON(){const raw=localStorage.getItem("period3_profiles_v5")||localStorage.getItem("period3_profiles_v4")||localStorage.getItem("period3_profiles_v3")||localStorage.getItem("period3_profiles_v2")||localStorage.getItem("period3_profiles_v1");const data=raw?JSON.parse(raw):null;const payload={version:"v0.9",exportedAt:new Date().toISOString(),profiles:data};download(`fleurdiary_backup_${toISO(new Date())}.json`,JSON.stringify(payload,null,2));}
      function exportCSV(){const raw=localStorage.getItem("period3_profiles_v5")||localStorage.getItem("period3_profiles_v4")||localStorage.getItem("period3_profiles_v3")||localStorage.getItem("period3_profiles_v2")||localStorage.getItem("period3_profiles_v1");const data=raw?JSON.parse(raw):[];const rows=[["user_id","name(label)","type","date","start","end","flags","temp","note"]];(data||[]).forEach(p=>{(p.logs.periods||[]).forEach(pr=>rows.push([p.id,p.label,"period","",pr.start||"",pr.end||"","","",""]));Object.entries(p.logs.symptoms||{}).forEach(([date,sym])=>rows.push([p.id,p.label,"symptom",date,"","",(sym.flags||[]).join("|"),sym.temp||"",String(sym.note||"").replace(/\n/g," ")]));});const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(",")).join("\n");download(`fleurdiary_export_${toISO(new Date())}.csv`,csv);}
      function importJSONFile(e){const file=e.target.files&&e.target.files[0];if(!file) return;const reader=new FileReader();reader.onload=()=>{try{const obj=JSON.parse(String(reader.result||"{}"));if(Array.isArray(obj))localStorage.setItem("period3_profiles_v5",JSON.stringify(obj));else if(obj&&Array.isArray(obj.profiles))localStorage.setItem("period3_profiles_v5",JSON.stringify(obj.profiles));else{alert("JSONの形式が違います");return;}window.location.reload();}catch{alert("読み込みに失敗しました");}};reader.readAsText(file);}

      ReactDOM.createRoot(document.getElementById("root")).render(<App />);
    </script>

    <!-- Service Worker（キャッシュ） -->
    <script>
      const swCode = `
        const CACHE_NAME="fleur-diary-cache-v1";
        const APP_SHELL=["/","/index.html"];
        self.addEventListener("install",e=>{e.waitUntil(caches.open(CACHE_NAME).then(c=>c.addAll(APP_SHELL)));self.skipWaiting();});
        self.addEventListener("activate",e=>{e.waitUntil(caches.keys().then(keys=>Promise.all(keys.map(k=>k!==CACHE_NAME?caches.delete(k):Promise.resolve()))));self.clients.claim();});
        self.addEventListener("fetch",e=>{ if(e.request.method!=="GET")return; e.respondWith(caches.match(e.request).then(c=>c||fetch(e.request).then(r=>{const copy=r.clone(); caches.open(CACHE_NAME).then(cx=>cx.put(e.request,copy)); return r;}).catch(()=>c)));});
      `;
      if ("serviceWorker" in navigator && (location.protocol === "https:" || location.hostname === "localhost")) {
        const swUrl = URL.createObjectURL(new Blob([swCode], {type:"text/javascript"}));
        navigator.serviceWorker.register(swUrl).catch(()=>{});
      }
    </script>
  </body>
</html>
